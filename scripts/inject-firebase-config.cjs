#!/usr/bin/env node

/**
 * Firebase Config Injection Script
 * 
 * This script injects Firebase configuration into the service worker file
 * before the build process. It ensures that all required Firebase environment
 * variables are present and fails fast with clear error messages if any are missing.
 * 
 * This prevents service worker config placeholders from shipping to production.
 */

const fs = require('fs');
const path = require('path');

// Required Firebase environment variables
const REQUIRED_ENV_VARS = [
  'VITE_FIREBASE_API_KEY',
  'VITE_FIREBASE_AUTH_DOMAIN',
  'VITE_FIREBASE_PROJECT_ID',
  'VITE_FIREBASE_STORAGE_BUCKET',
  'VITE_FIREBASE_MESSAGING_SENDER_ID',
  'VITE_FIREBASE_APP_ID',
  'VITE_FIREBASE_VAPID_KEY'
];

/**
 * Validates that all required environment variables are present
 * @throws {Error} If any required env var is missing
 */
function validateEnvironmentVariables() {
  const missing = [];
  
  for (const envVar of REQUIRED_ENV_VARS) {
    if (!process.env[envVar] || process.env[envVar].trim() === '') {
      missing.push(envVar);
    }
  }
  
  if (missing.length > 0) {
    console.error('\n‚ùå ERROR: Missing required Firebase environment variables:\n');
    missing.forEach(varName => {
      console.error(`   - ${varName}`);
    });
    console.error('\nPlease set these variables in your .env file before building.');
    console.error('See .env.example for reference.\n');
    process.exit(1);
  }
  
  console.log('‚úÖ All required Firebase environment variables are present');
}

/**
 * Generates the firebase-messaging-sw.js file with injected config
 */
function generateServiceWorkerFile() {
  const outputPath = path.join(__dirname, '../public/firebase-messaging-sw.js');
  
  const serviceWorkerContent = `// Firebase Cloud Messaging Service Worker
// This file is auto-generated by scripts/inject-firebase-config.cjs
// DO NOT EDIT THIS FILE MANUALLY - it will be overwritten on build

importScripts('https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js');

// Firebase configuration injected at build time
const firebaseConfig = {
  apiKey: "${process.env.VITE_FIREBASE_API_KEY}",
  authDomain: "${process.env.VITE_FIREBASE_AUTH_DOMAIN}",
  projectId: "${process.env.VITE_FIREBASE_PROJECT_ID}",
  storageBucket: "${process.env.VITE_FIREBASE_STORAGE_BUCKET}",
  messagingSenderId: "${process.env.VITE_FIREBASE_MESSAGING_SENDER_ID}",
  appId: "${process.env.VITE_FIREBASE_APP_ID}"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Retrieve an instance of Firebase Messaging
const messaging = firebase.messaging();

// Handle background messages
messaging.onBackgroundMessage((payload) => {
  console.log('[firebase-messaging-sw.js] Received background message:', payload);
  
  const notificationTitle = payload.notification?.title || 'EasyFlows Pro';
  const notificationOptions = {
    body: payload.notification?.body || '',
    icon: '/pwa-192x192.svg',
    badge: '/pwa-192x192.svg',
    data: payload.data || {},
    tag: payload.data?.type || 'general',
    requireInteraction: false,
  };

  return self.registration.showNotification(notificationTitle, notificationOptions);
});

// Handle notification clicks
self.addEventListener('notificationclick', (event) => {
  console.log('[firebase-messaging-sw.js] Notification clicked:', event);
  
  event.notification.close();
  
  const urlToOpen = event.notification.data?.link || '/';
  
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true })
      .then((clientList) => {
        // Focus existing window if available
        for (const client of clientList) {
          if (client.url === urlToOpen && 'focus' in client) {
            return client.focus();
          }
        }
        // Open new window if none found
        if (clients.openWindow) {
          return clients.openWindow(urlToOpen);
        }
      })
  );
});
`;

  try {
    fs.writeFileSync(outputPath, serviceWorkerContent, 'utf8');
    console.log(`‚úÖ Generated: ${outputPath}`);
    console.log('   Firebase config successfully injected into service worker\n');
  } catch (error) {
    console.error(`\n‚ùå ERROR: Failed to write service worker file: ${error.message}\n`);
    process.exit(1);
  }
}

/**
 * Main execution
 */
function main() {
  console.log('\nüî• Firebase Service Worker Config Injection\n');
  console.log('This script injects Firebase configuration into firebase-messaging-sw.js');
  console.log('to ensure push notifications work correctly in production.\n');
  
  // Step 1: Validate environment variables
  validateEnvironmentVariables();
  
  // Step 2: Generate service worker file
  generateServiceWorkerFile();
  
  console.log('‚úÖ Firebase service worker configuration injection complete!\n');
}

// Run the script
main();
