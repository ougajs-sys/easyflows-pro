# Firebase Service Worker Configuration Scripts

## Overview

This directory contains scripts for injecting Firebase configuration into service worker files before build time.

## Scripts

### `inject-firebase-config.cjs`

**Purpose**: Generates `public/firebase-messaging-sw.js` with Firebase Cloud Messaging configuration injected from environment variables.

**When it runs**: Automatically before every production build via the `prebuild` npm script.

**Why it's needed**: 
- Firebase Cloud Messaging requires a service worker file in the public directory with Firebase configuration
- The configuration must be injected at build time to prevent placeholder values from shipping to production
- The script validates that all required Firebase environment variables are present and fails fast with clear error messages if any are missing

**Required Environment Variables**:
- `VITE_FIREBASE_API_KEY`
- `VITE_FIREBASE_AUTH_DOMAIN`
- `VITE_FIREBASE_PROJECT_ID`
- `VITE_FIREBASE_STORAGE_BUCKET`
- `VITE_FIREBASE_MESSAGING_SENDER_ID`
- `VITE_FIREBASE_APP_ID`
- `VITE_FIREBASE_VAPID_KEY`

**Usage**:
```bash
# Runs automatically before build
npm run build

# Or run manually
node scripts/inject-firebase-config.cjs
```

**Output**: 
- Generates `public/firebase-messaging-sw.js` (git-ignored, auto-generated file)
- This file is served at `/firebase-messaging-sw.js` and handles background push notifications

**Error Handling**:
- If any required environment variable is missing, the script will:
  1. Print a clear error message listing all missing variables
  2. Exit with code 1 (failing the build)
  3. Prevent deployment with incomplete Firebase configuration

## Service Worker Architecture

The push notification system uses two service workers:

1. **`firebase-messaging-sw.js`** (this auto-generated file)
   - Located in `public/` directory
   - Handles Firebase Cloud Messaging background messages
   - Contains injected Firebase configuration
   - Auto-generated by `inject-firebase-config.cjs`

2. **`service-worker.ts`** (manual, source-controlled)
   - Located in `src/` directory
   - Built by Vite PWA plugin
   - Handles app caching and general PWA functionality
   - Managed by Workbox

Both service workers work together to provide a complete PWA experience with push notifications.

## Development Notes

- The generated `firebase-messaging-sw.js` file is git-ignored (see `.gitignore`)
- Always run the injection script before building for production
- The script is idempotent - safe to run multiple times
- If you update Firebase environment variables, re-run the build to regenerate the service worker

## Troubleshooting

**Build fails with "Missing required Firebase environment variables"**:
- Ensure all Firebase env vars are set in your `.env` file
- See `.env.example` for the complete list
- Verify env vars don't have trailing spaces or quotes

**Push notifications not working in production**:
- Verify the prebuild script ran successfully during deployment
- Check that `firebase-messaging-sw.js` exists at the root URL
- Verify Firebase environment variables are set in your deployment platform (Netlify/Vercel)
